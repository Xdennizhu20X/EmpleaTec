<div class="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 font-sans text-gray-800">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/30 backdrop-blur-lg">
    <div class="flex h-20 items-center justify-between sm:px-8 px-3">
      <button (click)="onBack()"
        class="flex items-center gap-2 rounded-full p-2 sm:mr-0 mr-4 text-gray-600 transition-colors duration-200 hover:bg-gray-200/50 hover:text-blue-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span class="hidden sm:inline font-medium">Volver</span>
      </button>
      <h1 class="text-xl font-bold text-blue-900">Crear un Nuevo Proyecto</h1>
      <div class="text-sm font-semibold text-blue-700">
        Paso {{ currentStep() }} de 4
      </div>
    </div>
  </header>

  <!-- Page Content -->
  <main class="p-4 sm:p-8">
    <div class="mx-auto max-w-3xl">
      <!-- Progress Bar -->
      <div class="mb-8">
        <div class="relative flex justify-between w-full">
          <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-200/80 -translate-y-1/2"></div>
          <div class="absolute top-1/2 left-0 h-1 bg-blue-500 -translate-y-1/2 transition-all duration-500"
          [style.width]="((currentStep() - 1) / 3) * 100 + '%'"></div>
          @for (step of [1, 2, 3, 4]; track step) {
            <div class="relative z-10">
              <div class="flex h-10 w-10 items-center justify-center rounded-full border-2 transition-all duration-300"
                [ngClass]="step <= currentStep() ? 'border-blue-500 bg-blue-500 text-white' : 'border-gray-300 bg-white text-gray-500'">
                @if (step < currentStep()) {
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                }
                @if (step >= currentStep()) {
                  <span class="text-lg font-bold">{{ step }}</span>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Step Content -->
      <div class="bg-white/50 backdrop-blur-lg rounded-2xl shadow-sm">
        <div>
          @switch (currentStep()) {
            <!-- PASO 1: Información Básica -->
            @case (1) {
              <div class="p-6 sm:p-8">
                <h3 class="text-2xl font-bold text-blue-900 mb-6">Describe tu proyecto</h3>
                <div class="space-y-6">
                  <div>
                    <label for="title" class="text-sm font-medium text-gray-700 mb-2 block">Título del Proyecto *</label>
                    <input id="title" type="text" [ngModel]="formData().title"
                      (ngModelChange)="handleInputChange('title', $event)"
                      placeholder="Ej: Instalar cocina integral y azulejos"
                      class="w-full px-4 py-2.5 bg-white/50 border border-gray-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                      @if (errors()['title']) {
                        <p class="mt-1.5 text-sm text-red-600">{{ errors()['title'] }}</p>
                      }
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700 mb-2 block">Categoría *</label>
                      <div class="grid grid-cols-2 gap-3 sm:grid-cols-4">
                        @for (category of categories; track category) {
                          <button type="button"
                            (click)="handleInputChange('category', category.id)"
                            class="px-4 py-2 rounded-lg transition-colors duration-200 text-center"
                            [ngClass]="formData().category === category.id ? 'bg-blue-500 text-white shadow-md' : 'text-gray-700 bg-gray-200/50 hover:bg-gray-200'">
                            <span class="font-medium">{{ category.icon }} {{ category.name }}</span>
                          </button>
                        }
                      </div>
                      @if (errors()['category']) {
                        <p class="mt-1.5 text-sm text-red-600">{{ errors()['category'] }}</p>
                      }
                    </div>
                    <div>
                      <label for="description" class="text-sm font-medium text-gray-700 mb-2 block">Descripción Detallada
                      *</label>
                      <textarea id="description" [ngModel]="formData().description"
                        (ngModelChange)="handleInputChange('description', $event)"
                        placeholder="Describe lo que necesitas con el mayor detalle posible..." rows="5"
                      class="w-full px-4 py-2.5 bg-white/50 border border-gray-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                      @if (errors()['description']) {
                        <p class="mt-1.5 text-sm text-red-600">{{ errors()['description'] }}</p>
                      }
                    </div>
                  </div>
                </div>
              }
              <!-- PASO 2: Ubicación y Presupuesto -->
              @case (2) {
                <div class="p-6 sm:p-8">
                  <h3 class="text-2xl font-bold text-blue-900 mb-6">Ubicación y Presupuesto</h3>
                  <div class="space-y-6">
                    <div>
                      <label for="location" class="text-sm font-medium text-gray-700 mb-2 block">Ubicación del Proyecto
                      *</label>
                      <div class="relative">
                        <input id="location" type="text" [ngModel]="formData().location"
                          (ngModelChange)="handleInputChange('location', $event)" placeholder="Colonia, Ciudad, Estado"
                          class="w-full pl-11 pr-4 py-2.5 bg-white/50 border border-gray-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                          <svg xmlns="http://www.w3.org/2000/svg"
                            class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round"
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                      </div>
                      @if (errors()['location']) {
                        <p class="mt-1.5 text-sm text-red-600">{{ errors()['location'] }}</p>
                      }
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700 mb-2 block">Tipo de Presupuesto</label>
                      <div class="grid grid-cols-2 gap-3">
                        <button type="button" (click)="handleBudgetChange('type', 'fixed')"
                          class="px-4 py-3 rounded-lg transition-colors duration-200 text-center border-2"
                          [ngClass]="formData().budget.type === 'fixed' ? 'border-blue-500 bg-blue-50' : 'border-transparent bg-gray-200/50 hover:bg-gray-200'">
                          <span class="font-bold text-blue-900">Precio Fijo</span>
                          <span class="text-xs text-gray-600 block">Por todo el proyecto</span>
                        </button>
                        <button type="button" (click)="handleBudgetChange('type', 'hourly')"
                          class="px-4 py-3 rounded-lg transition-colors duration-200 text-center border-2"
                          [ngClass]="formData().budget.type === 'hourly' ? 'border-blue-500 bg-blue-50' : 'border-transparent bg-gray-200/50 hover:bg-gray-200'">
                          <span class="font-bold text-blue-900">Por Hora</span>
                          <span class="text-xs text-gray-600 block">Tarifa por hora de trabajo</span>
                        </button>
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700 mb-2 block">Rango de Presupuesto * (MXN)</label>
                      <div class="grid grid-cols-2 gap-3">
                        <input type="number" [ngModel]="formData().budget.min"
                          (ngModelChange)="handleBudgetChange('min', +$event)" placeholder="Mínimo"
                          class="w-full px-4 py-2.5 bg-white/50 border border-gray-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                          <input type="number" [ngModel]="formData().budget.max"
                            (ngModelChange)="handleBudgetChange('max', +$event)" placeholder="Máximo"
                            class="w-full px-4 py-2.5 bg-white/50 border border-gray-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                          </div>
                          @if (errors()['budget']) {
                            <p class="mt-1.5 text-sm text-red-600">{{ errors()['budget'] }}</p>
                          }
                        </div>
                      </div>
                    </div>
                  }
                  <!-- PASO 3: Cronograma -->
                  @case (3) {
                    <div class="p-6 sm:p-8">
                      <h3 class="text-2xl font-bold text-blue-900 mb-6">Define el Cronograma</h3>
                      <div class="space-y-6">
                        <div>
                          <label class="text-sm font-medium text-gray-700 mb-2 block">Urgencia del Proyecto</label>
                          <div class="space-y-3">
                            @for (level of urgencyLevels; track level) {
                              <button type="button"
                                (click)="handleTimelineChange('urgency', level.id)"
                                class="w-full text-left px-4 py-3 rounded-lg transition-colors duration-200 border-2"
                                [ngClass]="formData().timeline.urgency === level.id ? 'border-blue-500 bg-blue-50' : 'border-transparent bg-gray-200/50 hover:bg-gray-200'">
                                <div class="font-bold text-blue-900">{{ level.name }}</div>
                                <div class="text-sm text-gray-600">{{ level.description }}</div>
                              </button>
                            }
                          </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                          <div>
                            <label for="start-date" class="text-sm font-medium text-gray-700 mb-2 block">Fecha de Inicio *</label>
                            <input id="start-date" type="date" [ngModel]="formData().timeline.start"
                              (ngModelChange)="handleTimelineChange('start', $event)"
                              class="w-full px-4 py-2.5 bg-white/50 border border-gray-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                              @if (errors()['timeline']) {
                                <p class="mt-1.5 text-sm text-red-600">{{ errors()['timeline'] }}</p>
                              }
                            </div>
                            <div>
                              <label for="end-date" class="text-sm font-medium text-gray-700 mb-2 block">Fecha Límite
                              (Opcional)</label>
                              <input id="end-date" type="date" [ngModel]="formData().timeline.end"
                                (ngModelChange)="handleTimelineChange('end', $event)"
                                class="w-full px-4 py-2.5 bg-white/50 border border-gray-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                              </div>
                            </div>
                          </div>
                        </div>
                      }
                      <!-- PASO 4: Revisión -->
                      @case (4) {
                        <div class="p-6 sm:p-8">
                          <h3 class="text-2xl font-bold text-blue-900 mb-6">Revisa y Publica tu Proyecto</h3>
                          <div class="space-y-6">
                            <div class="mb-6">
                              <label class="text-sm font-medium text-gray-700 mb-2 block">Imágenes de Referencia (Opcional)</label>
                              <div class="flex items-center justify-center w-full" (dragover)="onDragOver($event)"
                                (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
                              <label for="dropzone-file"
                                class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer transition-all"
                                [class.border-blue-400]="isDragging()" [class.bg-blue-50]="isDragging()">
                                @if (previewUrls().length === 0) {
                                  <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mb-3"
                                      [class.text-blue-500]="isDragging()" [class.text-gray-400]="!isDragging()" fill="none"
                                      viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16a4 4 0 01-4-4V6a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7z" />
                                    </svg>
                                    <p class="mb-2 text-sm" [class.text-blue-600]="isDragging()"
                                      [class.text-gray-500]="!isDragging()">
                                      <span class="font-semibold">Click para subir</span> o arrastra y suelta
                                    </p>
                                    <p class="text-xs text-gray-500">JPEG, PNG, GIF o WebP (max. 5MB cada una)</p>
                                  </div>
                                }
                                <!-- Vista previa cuando hay imágenes -->
                                @if (previewUrls().length > 0) {
                                  <div class="p-4 w-full">
                                    <div class="grid grid-cols-3 gap-2">
                                      @for (url of previewUrls(); track url; let i = $index) {
                                        <div class="relative group">
                                          <img [src]="url" alt="Preview" class="w-full h-24 object-cover rounded-md border">
                                          <button type="button" (click)="removeImage(i)"
                                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600 transition">
                                            ×
                                          </button>
                                        </div>
                                      }
                                      <!-- Espacio para añadir más imágenes -->
                                      @if (previewUrls().length < 5) {
                                        <div
                                          class="flex items-center justify-center border-2 border-dashed rounded-md h-24">
                                          <span class="text-gray-400 text-sm">+ Añadir más</span>
                                        </div>
                                      }
                                    </div>
                                  </div>
                                }
                                <input id="dropzone-file" type="file" class="hidden"
                                  accept="image/jpeg, image/png, image/gif, image/webp" multiple
                                  (change)="onFileSelected($event)" />
                              </label>
                            </div>
                            <!-- Mensajes de error -->
                            @if (uploadError()) {
                              <p class="mt-2 text-sm text-red-600">{{ uploadError() }}</p>
                            }
                            <!-- Progreso de carga -->
                            @if (isUploadingImages()) {
                              <div class="mt-4">
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                  <div class="bg-blue-600 h-2.5 rounded-full" [style.width]="uploadProgress() + '%'"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Subiendo imágenes... {{ uploadProgress() }}%</p>
                              </div>
                            }
                          </div>
                        </div>
                        <div class="rounded-lg border border-gray-200/80 p-6 space-y-4">
                          <h4 class="text-lg font-bold text-blue-900">{{ formData().title }}</h4>
                          <p class="text-sm text-gray-700">{{ formData().description }}</p>
                          <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-semibold text-gray-600">Categoría:</span> {{
                          getCategoryById(formData().category)?.name }}</div>
                          <div><span class="font-semibold text-gray-600">Ubicación:</span> {{ formData().location }}</div>
                          <div><span class="font-semibold text-gray-600">Presupuesto:</span> ${{ formData().budget.min | number }}
                          - ${{ formData().budget.max | number }} ({{ formData().budget.type === 'fixed' ? 'Fijo' : 'Por Hora'
                        }})</div>
                        <div><span class="font-semibold text-gray-600">Inicio:</span> {{ formData().timeline.start |
                      date:'mediumDate':'':'es-MX' }}</div>
                    </div>
                  </div>
                </div>
              }
            }
          </div>

        </div>
      </div>

      <!-- Navigation -->
      <div class="mt-8 flex justify-between">
        <button (click)="prevStep()" [disabled]="currentStep() === 1"
          class="px-6 py-2.5 rounded-lg font-semibold text-gray-700 hover:bg-gray-200/50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
          Anterior
        </button>
        @if (currentStep() < 4) {
          <button (click)="nextStep()"
            class="px-6 py-2.5 rounded-lg font-bold text-white bg-blue-500 hover:bg-blue-600 transition-colors">
            Siguiente
          </button>
        }
        @if (currentStep() === 4) {
          <button (click)="handleSubmit()" [disabled]="isSubmitting()"
            class="px-6 py-2.5 rounded-lg font-bold text-white bg-blue-500 hover:bg-blue-600 disabled:opacity-70 transition-colors">
            {{ isSubmitting() ? 'Publicando...' : 'Publicar Proyecto' }}
          </button>
        }
      </div>
