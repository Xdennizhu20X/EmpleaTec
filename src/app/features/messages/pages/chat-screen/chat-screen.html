<div class="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 flex flex-col">
  <!-- Header -->
  <header class="bg-white/50 backdrop-blur-lg border-b border-white/30 sticky top-0 z-40">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <button (click)="onBack()" class="bg-white/20 backdrop-blur-lg border border-white/30 rounded-lg p-2 transition-colors hover:bg-white/40">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5m7 7l-7-7 7-7"/></svg>
          </button>

          <div *ngIf="currentParticipant() as participant" class="flex items-center space-x-3 cursor-pointer hover:bg-white/20 rounded-lg p-2 -m-2 transition-colors">
            <div class="relative">
              <img [src]="participant.avatar" [alt]="participant.name" class="w-10 h-10 rounded-full">
              <div *ngIf="participant.isOnline && !isChatFinalized()" class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
            </div>
            <div>
              <h3 class="font-semibold text-blue-900">
                {{ participant.name }}
              </h3>
              <div class="flex items-center space-x-2">
                <span *ngIf="participant.specialty" class="text-sm text-blue-600">
                  {{ participant.specialty }}
                </span>
                <span class="text-xs" [ngClass]="{'text-gray-500': isChatFinalized(), 'text-green-600': !isChatFinalized()}">
                  {{ isChatFinalized() ? 'Chat finalizado' : (participant.isOnline ? 'En línea' : 'Desconectado') }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="flex items-center space-x-2">
          <ng-container *ngIf="!isChatFinalized()">
            <button class="bg-white/20 backdrop-blur-lg border border-white/30 rounded-lg p-2 transition-colors hover:bg-white/40">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            </button>
            <button class="bg-white/20 backdrop-blur-lg border border-white/30 rounded-lg p-2 transition-colors hover:bg-white/40">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5"/><rect x="2" y="6" width="14" height="12" rx="2"/></svg>
            </button>
          </ng-container>
          <button class="bg-white/20 backdrop-blur-lg border border-white/30 rounded-lg p-2 transition-colors hover:bg-white/40">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
          </button>
        </div>
      </div>

      <!-- Project Info -->
      <div class="mt-3 pt-3 border-t border-white/20 flex items-center justify-between">
        <div class="border-blue-300 text-blue-700 bg-blue-50 px-3 py-1 rounded-full text-sm">
          Proyecto: {{ currentProjectTitle() }}
        </div>

        <!-- Finalize Chat Button -->
        <button *ngIf="!isChatFinalized()" (click)="handleFinalizarChat()" class="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1 rounded-md flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2zM12 8v4m0 4h.01"/></svg>
          Finalizar chat
        </button>

        <div *ngIf="isChatFinalized()" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2zM12 8v4m0 4h.01"/></svg>
          Chat finalizado
        </div>
      </div>
    </div>
  </header>

  <!-- Messages Container -->
  <div class="flex-1 overflow-hidden flex flex-col">
    <div #messagesContainer class="flex-1 overflow-y-auto px-6 py-6">
      <div class="max-w-4xl mx-auto space-y-4">
        <ng-container *ngFor="let msg of messages(); let i = index">
          <div *ngIf="shouldShowDateHeader(msg, messages()[i - 1])" class="flex justify-center my-6">
            <div class="bg-white/50 backdrop-blur-lg text-blue-700 px-4 py-2 rounded-full">
              {{ formatDateHeader(msg.timestamp) }}
            </div>
          </div>

          <div *ngIf="msg.senderId === 'system'" class="flex justify-center my-4">
            <div class="bg-white/50 backdrop-blur-lg border border-orange-200 bg-orange-50/50 px-4 py-2 rounded-lg max-w-md">
              <div class="flex items-center space-x-2 text-orange-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                <span class="text-sm font-medium">{{ msg.text }}</span>
              </div>
            </div>
          </div>

          <div *ngIf="msg.senderId !== 'system' && currentUser() as user" class="flex items-end space-x-2" [ngClass]="{'justify-end': msg.senderId === user.uid, 'justify-start': msg.senderId !== user.uid}">
            <img *ngIf="msg.senderId !== user.uid && currentParticipant() as participant" [src]="participant.avatar" [alt]="participant.name" class="w-8 h-8 rounded-full">

            <div class="max-w-xs md:max-w-md" [ngClass]="{'order-first': msg.senderId === user.uid}">
              <div class="rounded-2xl px-4 py-3" [ngClass]="{'bg-blue-600 text-white ml-auto': msg.senderId === user.uid, 'bg-white/50 backdrop-blur-lg border border-white/30': msg.senderId !== user.uid}">
                <img *ngIf="msg.type === 'image'" [src]="msg.text" alt="Imagen compartida" class="rounded-lg max-w-full h-auto cursor-pointer hover:opacity-90 transition-opacity">
                <p *ngIf="msg.type === 'text'" [ngClass]="{'text-white': msg.senderId === user.uid, 'text-blue-800': msg.senderId !== user.uid}">
                  {{ msg.text }}
                </p>
              </div>

              <div class="flex items-center mt-1 space-x-1" [ngClass]="{'justify-end': msg.senderId === user.uid, 'justify-start': msg.senderId !== user.uid}">
                <span class="text-xs text-blue-500">{{ formatMessageTime(msg.timestamp) }}</span>
                <div *ngIf="msg.senderId === user.uid" class="text-blue-500">
                  <svg *ngIf="msg.isRead" xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 7 17l-5-5"/><path d="m22 6-11 11-5-5"/></svg>
                  <svg *ngIf="!msg.isRead" xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                </div>
              </div>
            </div>

            <div *ngIf="msg.senderId === user.uid" class="w-8 h-8 rounded-full bg-blue-100 text-blue-800 flex items-center justify-center text-xs">
              Yo
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- Message Input -->
    <div class="border-t border-white/30 bg-white/20 backdrop-blur-sm" [class.opacity-50]="isChatFinalized()">
      <div class="container mx-auto px-6 py-4 max-w-4xl">
        <div *ngIf="isChatFinalized()" class="flex items-center justify-center space-x-2 text-blue-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2zM12 8v4m0 4h.01"/></svg>
          <span class="font-medium">Este chat ha sido finalizado</span>
        </div>

        <div *ngIf="!isChatFinalized()" class="flex items-end space-x-3">
          <button class="bg-white/20 backdrop-blur-lg border border-white/30 rounded-lg p-2 transition-colors hover:bg-white/40">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
          </button>
          <button class="bg-white/20 backdrop-blur-lg border border-white/30 rounded-lg p-2 transition-colors hover:bg-white/40">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
          </button>

          <div class="flex-1 relative">
            <input #inputRef [ngModel]="message()" (ngModelChange)="message.set($event)" (keydown)="handleKeyPress($event)" placeholder="Escribe tu mensaje..." [disabled]="isChatFinalized()" class="bg-white/50 backdrop-blur-lg border-0 pl-5 py-3 rounded-xl text-blue-800 placeholder-blue-500 w-full">
            
          </div>

          <button (click)="handleSendMessage()" [disabled]="!message().trim() || isChatFinalized()" class="rounded-xl px-4 py-3 transition-all duration-200" [ngClass]="{'bg-blue-600 hover:bg-blue-700 text-white shadow-lg hover:shadow-xl': message().trim() && !isChatFinalized(), 'bg-white/20 backdrop-blur-lg border border-white/30 rounded-lg p-2 transition-colors hover:bg-white/40 text-blue-400 cursor-not-allowed': !message().trim() || isChatFinalized()}">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Finalization Confirmation Dialog -->
  <div *ngIf="showFinalizationDialog()" class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center">
    <div class="bg-white/70 backdrop-blur-xl border border-white/20 shadow-lg p-6 rounded-lg max-w-md w-full">
      <h3 class="flex items-center space-x-2 text-blue-900 font-semibold text-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
        <span>Finalizar Chat</span>
      </h3>
      <div class="py-4">
        <p class="text-blue-700 mb-4">¿Estás seguro de que quieres finalizar este chat? Una vez finalizado:</p>
        <ul class="space-y-2 text-sm text-blue-600">
          <li class="flex items-center space-x-2"><div class="w-2 h-2 bg-blue-400 rounded-full"></div><span>No podrás enviar más mensajes</span></li>
          <li class="flex items-center space-x-2"><div class="w-2 h-2 bg-blue-400 rounded-full"></div><span>Se te pedirá calificar al otro usuario</span></li>
          <li class="flex items-center space-x-2"><div class="w-2 h-2 bg-blue-400 rounded-full"></div><span>La conversación quedará archivada</span></li>
        </ul>
      </div>
      <div class="flex justify-end space-x-3">
        <button (click)="showFinalizationDialog.set(false)" class="bg-white/20 backdrop-blur-lg border border-white/30 rounded-lg p-2 transition-colors hover:bg-white/40 text-blue-700 px-4 py-2 rounded-md">Cancelar</button>
        <button (click)="confirmFinalizarChat()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2zM12 8v4m0 4h.01"/></svg>
          Finalizar Chat
        </button>
      </div>
    </div>
  </div>

  <!-- Rating Dialog -->
  <div *ngIf="showRatingDialog()" class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center">
    <div *ngIf="currentParticipant() as participant" class="bg-white/70 backdrop-blur-xl border border-white/20 shadow-lg p-6 rounded-lg max-w-md w-full">
      <h3 class="flex items-center space-x-2 text-blue-900 font-semibold text-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-yellow-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        <span>Calificar a {{ participant.name }}</span>
      </h3>

      <ng-container *ngIf="!finalizationData().isSubmitted; else ratingSubmitted">
        <div class="py-4 space-y-6">
          <div class="text-center">
            <img [src]="participant.avatar" [alt]="participant.name" class="w-16 h-16 mx-auto mb-3 rounded-full">
            <p class="text-blue-700">¿Cómo fue tu experiencia con {{ participant.name }}?</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-blue-600 mb-3">Calificación</p>
            <!-- Rating component would be here -->
          </div>
          <div>
            <label class="block text-sm font-medium text-blue-700 mb-2">Comentario (opcional)</label>
            <textarea [ngModel]="finalizationData().comment" (ngModelChange)="updateFinalizationComment($event)" placeholder="Comparte tu opinión sobre este profesional..." class="bg-white/50 backdrop-blur-lg border-0 text-blue-800 placeholder-blue-500 w-full rounded-md p-2" rows="3"></textarea>
          </div>
        </div>
        <div class="flex justify-end space-x-3">
          <button (click)="showRatingDialog.set(false)" class="bg-white/20 backdrop-blur-lg border border-white/30 rounded-lg p-2 transition-colors hover:bg-white/40 text-blue-700 px-4 py-2 rounded-md">Saltar</button>
          <button (click)="handleSubmitRating()" [disabled]="finalizationData().rating === 0" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            Enviar Calificación
          </button>
        </div>
      </ng-container>

      <ng-template #ratingSubmitted>
        <div class="py-8 text-center">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
          </div>
          <h3 class="font-semibold text-blue-900 mb-2">¡Calificación enviada!</h3>
          <p class="text-blue-600">Gracias por tu opinión. Esto nos ayuda a mejorar la plataforma.</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>